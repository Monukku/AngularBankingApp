<div class="dashboard-container">

  <!-- ‚ïê‚ïê‚ïê Ambient Background ‚ïê‚ïê‚ïê -->
  <div class="bg-texture"></div>
  <div class="scan-line"></div>
  <div class="orb orb-violet"></div>
  <div class="orb orb-cyan"></div>
  <div class="orb orb-rose"></div>
  <div class="orb orb-emerald"></div>

  <!-- ‚ïê‚ïê‚ïê Loading Overlay ‚ïê‚ïê‚ïê -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner></mat-spinner>
      <p>Loading dashboard...</p>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê Error Banner ‚ïê‚ïê‚ïê -->
  @if (hasError()) {
    <div class="error-banner">
      <span>‚ö†Ô∏è Failed to load dashboard data.</span>
      <button mat-button (click)="loadDashboardData()">Retry</button>
    </div>
  }

  <!-- ‚ïê‚ïê‚ïê Stat Cards ‚ïê‚ïê‚ïê -->
  <div class="stat-cards-row">
    @for (card of statCards(); track card.label) {
      <div class="stat-card" [attr.data-color]="card.color">
        <div class="stat-blob"></div>
        <div class="stat-icon-wrap">{{ card.icon }}</div>
        <div class="stat-label">{{ card.label }}</div>
        <div class="stat-value">
          @if (card.isPercent) {
            {{ card.value }}%
          } @else {
            ${{ card.value | number:'1.0-0' }}
          }
        </div>
        <span class="stat-change" [class.up]="card.isPositive" [class.down]="!card.isPositive">
          {{ card.isPositive ? '‚Üë' : '‚Üì' }} {{ card.changeLabel }}
        </span>
      </div>
    }
  </div>

  <!-- ‚ïê‚ïê‚ïê Main Grid ‚ïê‚ïê‚ïê -->
  <div class="dashboard-grid" [class.loading]="isLoading()">

    <!-- ‚ïê‚ïê LEFT SECTION ‚ïê‚ïê -->
    <div class="left-section">

      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-card-inner">
          <div class="balance-left">
            <h3 class="card-label">Total Balance in {{ balanceData()?.currency || 'USD' }}</h3>
            <div class="balance-amount">
              <span class="balance-live-dot"></span>
              ${{ totalBalance() | number:'1.0-0' }}
            </div>
            <div class="quick-actions">
              <button mat-raised-button color="primary" class="action-btn action-send" (click)="onSend()">
                <span class="action-icon">‚Üë</span> Send
              </button>
              <button mat-stroked-button class="action-btn outlined" (click)="onRequest()">
                <span class="action-icon">‚Üì</span> Request
              </button>
              <button mat-stroked-button class="action-btn outlined" (click)="onTopUp()">
                <span class="action-icon">+</span> Top-Up
              </button>
            </div>
          </div>

          <div class="balance-right">
            <div class="live-indicator">
              <div class="live-dot-sm"></div>
              LIVE
              <div class="waveform">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
              </div>
            </div>
            <div class="mini-ring-wrap">
              <svg class="mini-ring" viewBox="0 0 80 80">
                <defs>
                  <linearGradient id="ringGrad" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#a78bfa"/>
                    <stop offset="100%" stop-color="#06b6d4"/>
                  </linearGradient>
                </defs>
                <circle cx="40" cy="40" r="32" fill="none"
                        stroke="rgba(255,255,255,0.08)" stroke-width="8"/>
                <circle cx="40" cy="40" r="32" fill="none"
                        stroke="url(#ringGrad)" stroke-width="8"
                        stroke-linecap="round"
                        [attr.stroke-dasharray]="201"
                        [attr.stroke-dashoffset]="savingsRingOffset()"
                        transform="rotate(-90 40 40)"
                        class="ring-progress"/>
                <text x="40" y="36" text-anchor="middle" fill="white"
                      font-size="12" font-weight="700">{{ savingsGoalPercent() }}%</text>
                <text x="40" y="50" text-anchor="middle"
                      fill="rgba(255,255,255,0.6)" font-size="8">saved</text>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Transaction -->
      <div class="quick-transaction-card">
        <h3 class="card-title">
          <span class="card-title-icon">‚ö°</span> Quick Transaction
        </h3>
        <div class="users-carousel">
          @for (user of quickUsers(); track user.id) {
            <div class="user-item"
                 (click)="onUserClick(user)"
                 [attr.aria-label]="'Send to ' + user.name"
                 role="button"
                 tabindex="0">
              <div class="user-avatar">
                @if (user.avatar) {
                  <img [src]="user.avatar" [alt]="user.name" />
                } @else {
                  <span>{{ user.name.charAt(0).toUpperCase() }}</span>
                }
              </div>
              <div class="user-name">{{ user.name.split(' ')[0] }}</div>
              @if (user.amount) {
                <div class="user-amount">{{ user.amount }}</div>
              }
            </div>
          }
          <button mat-icon-button class="scroll-btn" aria-label="Scroll users right">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">

        <!-- Income Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <div class="chart-label-row">
                <span class="chart-dot-accent" style="background:#a78bfa"></span>
                <h4 class="chart-label">Total Income</h4>
              </div>
              @if (incomeData(); as income) {
                <div class="chart-value">
                  ${{ income.total | number:'1.0-0' }}
                  <span class="change-badge"
                        [class.positive]="income.isPositive"
                        [class.negative]="!income.isPositive">
                    <mat-icon>{{ income.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ income.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select" (change)="onPeriodChange($event)">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          <div class="chart-container" #incomeChartWrap>
            @if (incomeChartData().length) {
              <ngx-charts-area-chart
                [view]="chartView()"
                [results]="incomeChartData()"
                [xAxis]="showXAxis" [yAxis]="showYAxis"
                [gradient]="gradient" [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline" [scheme]="incomeColorScheme"
                [autoScale]="autoScale" [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>

        <!-- Spending Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <div class="chart-label-row">
                <span class="chart-dot-accent" style="background:#06b6d4"></span>
                <h4 class="chart-label">Total Spent</h4>
              </div>
              @if (spendingData(); as spending) {
                <div class="chart-value">
                  ${{ spending.total | number:'1.0-0' }}
                  <span class="change-badge"
                        [class.positive]="spending.isPositive"
                        [class.negative]="!spending.isPositive">
                    <mat-icon>{{ spending.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ spending.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select" (change)="onPeriodChange($event)">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          <div class="chart-container" #spendingChartWrap>
            @if (spendingChartData().length) {
              <ngx-charts-area-chart
                [view]="chartView()"
                [results]="spendingChartData()"
                [xAxis]="showXAxis" [yAxis]="showYAxis"
                [gradient]="gradient" [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline" [scheme]="spendingColorScheme"
                [autoScale]="autoScale" [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>

      </div>

      <!-- ‚ïê‚ïê‚ïê Transaction History ‚Äî native table (no mat-table) ‚ïê‚ïê‚ïê -->
      <div class="transaction-history-card">
        <div class="history-header">
          <div class="card-title-row">
            <h3 class="card-title">
              <span class="card-title-icon">üßæ</span> Transaction History
            </h3>
            <span class="history-badge">{{ filteredTransactions().length }} records</span>
          </div>
          <div class="history-controls">
            <div class="search-box">
              <mat-icon>search</mat-icon>
              <input type="text"
                     placeholder="Search transactions‚Ä¶"
                     [value]="searchQuery()"
                     (input)="onSearchChange($event)" />
            </div>
            <select class="period-select" (change)="onPeriodChange($event)">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
            <button mat-icon-button class="filter-btn" aria-label="Filter transactions">
              <mat-icon>filter_list</mat-icon>
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="tx-table">
            <thead>
              <tr>
                <th class="col-check"><mat-checkbox></mat-checkbox></th>
                <th>Invoice</th>
                <th>Transaction</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              @for (row of filteredTransactions(); track row.invoice) {
                <tr class="tx-row">

                  <td class="col-check"><mat-checkbox></mat-checkbox></td>

                  <td>
                    <div class="invoice-cell">
                      <span class="invoice-icon">üìÑ</span>
                      {{ row.invoice }}
                    </div>
                  </td>

                  <td>
                    <div class="transaction-cell">
                      <div class="company-logo">
                        <img [src]="row.logo" [alt]="row.name" />
                      </div>
                      <div class="transaction-details">
                        <div class="transaction-name">{{ row.name }}</div>
                        <div class="transaction-category">{{ row.email || row.category }}</div>
                      </div>
                    </div>
                  </td>

                  <td>
                    <div class="date-cell">
                      <span class="date-main">{{ row.date | date:'dd MMM' }}</span>
                      <span class="date-year">{{ row.date | date:'yyyy' }}</span>
                    </div>
                  </td>

                  <td [class.negative]="row.amount < 0" [class.positive]="row.amount > 0">
                    <span class="amount-val">
                      {{ row.amount < 0 ? '‚àí' : '+' }}${{ (row.amount < 0 ? row.amount * -1 : row.amount) | number:'1.2-2' }}
                    </span>
                  </td>

                  <td>
                    <span class="status-badge"
                          [class.completed]="row.status === 'Completed'"
                          [class.progress]="row.status === 'On Progress'"
                          [class.pending]="row.status === 'Pending'"
                          [attr.aria-label]="'Status: ' + row.status">
                      @if (row.status === 'Completed') { <span aria-hidden="true">‚úì</span> }
                      @else if (row.status === 'On Progress') { <span aria-hidden="true">‚è≥</span> }
                      @else { <span aria-hidden="true">‚óè</span> }
                      {{ row.status }}
                    </span>
                  </td>

                </tr>
              }

              @if (!filteredTransactions().length) {
                <tr>
                  <td colspan="6">
                    <div class="empty-state">
                      <div class="empty-icon">üîç</div>
                      <div class="empty-title">No transactions found</div>
                      <div class="empty-sub">Try adjusting your search or date filter</div>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê RIGHT SIDEBAR ‚ïê‚ïê -->
    <div class="right-sidebar">

      <!-- My Cards -->
      <div class="widget-card cards-widget">
        <div class="widget-header">
          <h4 class="widget-title">
            <span class="widget-title-icon">üí≥</span> My Cards
          </h4>
          <button mat-button class="add-btn" (click)="onAddCard()">
            Add New <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>

        @if (currentCard(); as card) {
          <div class="credit-card">
            <div class="cc-circles"></div>
            <div class="card-top">
              <span class="card-brand">‚ñ£ Fundwise</span>
              <span class="card-type">{{ card.brand }}</span>
            </div>
            <div class="card-holder">{{ card.cardHolder }}</div>
            <div class="card-number">{{ formatCardNumber(card.cardNumber) }}</div>
            <div class="card-footer">
              <div>
                <span class="label">Exp</span>
                <span class="value">{{ card.expiryMonth }}/{{ card.expiryYear }}</span>
              </div>
              <div>
                <span class="label">CVV</span>
                <span class="value">‚Ä¢‚Ä¢‚Ä¢</span>
              </div>
            </div>
            @if (cards().length > 1) {
              <div class="card-navigation">
                <button mat-icon-button (click)="previousCard()" aria-label="Previous card">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <span>{{ selectedCard() + 1 }} / {{ cards().length }}</span>
                <button mat-icon-button (click)="nextCard()" aria-label="Next card">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>
            }
          </div>

          <div class="card-limit-row">
            <span class="card-limit-label">Available limit</span>
            <span class="card-limit-val">
              ${{ card.balance | number:'1.0-0' }} / ${{ card.limit | number:'1.0-0' }}
            </span>
          </div>
          <div class="limit-track">
            <div class="limit-fill" [style.width.%]="cardLimitPercent()"></div>
          </div>
        }
      </div>

      <!-- Conversion Rate -->
      <div class="widget-card conversion-widget">
        <h4 class="widget-title">
          <span class="widget-title-icon">üîÑ</span> Conversion Rate
        </h4>
        <div class="conversion-form">
          <div class="conversion-row">
            <label>From</label>
            <div class="input-group">
              <input type="number"
                     [value]="conversionAmount1()"
                     (input)="onAmount1Change($event)" />
              <select [value]="conversionCurrency1()" (change)="onCurrency1Change($event)">
                <option value="USD">üá∫üá∏ USD</option>
                <option value="EUR">üá™üá∫ EUR</option>
                <option value="GBP">üá¨üáß GBP</option>
              </select>
            </div>
          </div>
          <div class="conversion-swap-row">
            <div class="conversion-line"></div>
            <div class="swap-icon" role="button" aria-label="Swap currencies">‚áÖ</div>
            <div class="conversion-line"></div>
          </div>
          <div class="conversion-row">
            <label>To</label>
            <div class="input-group">
              <input type="number"
                     [value]="conversionAmount2()"
                     (input)="onAmount2Change($event)" />
              <select [value]="conversionCurrency2()" (change)="onCurrency2Change($event)">
                <option value="EUR">üá™üá∫ EUR</option>
                <option value="USD">üá∫üá∏ USD</option>
                <option value="GBP">üá¨üáß GBP</option>
              </select>
            </div>
          </div>
          <button mat-raised-button color="primary" class="convert-btn" (click)="convert()">
            <mat-icon>swap_horiz</mat-icon>
            Convert {{ conversionAmount1() }} {{ conversionCurrency1() }}
            = {{ conversionAmount2() | number:'1.2-2' }} {{ conversionCurrency2() }}
          </button>
        </div>

        <div class="live-rates">
          <div class="live-rates-header">
            <span class="rates-label">Live Rates</span>
            <div class="live-indicator-sm">
              <div class="live-dot-sm"></div> LIVE
            </div>
          </div>
          @for (rate of liveRates(); track rate.pair) {
            <div class="rate-row">
              <span class="rate-flag">{{ rate.flag }}</span>
              <span class="rate-pair">{{ rate.pair }}</span>
              <span class="rate-sparkline">{{ rate.sparkline }}</span>
              <span class="rate-val" [class.up]="rate.isUp" [class.down]="!rate.isUp">
                {{ rate.value }}
                <small>{{ rate.isUp ? '+' : '' }}{{ rate.change }}%</small>
              </span>
            </div>
          }
        </div>
      </div>

      <!-- Workflows + Budget -->
      <div class="widget-card workflows-widget">
        <div class="widget-header">
          <h4 class="widget-title">
            <span class="widget-title-icon">‚öôÔ∏è</span> Workflows
          </h4>
          <button mat-icon-button class="add-icon-btn" aria-label="Add workflow">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>

        <div class="workflow-list">
          @for (workflow of workflows(); track workflow.id) {
            <div class="workflow-item"
                 (click)="onWorkflowClick(workflow)"
                 role="button"
                 tabindex="0"
                 [attr.aria-label]="workflow.title">
              <div class="workflow-icon">{{ workflow.icon }}</div>
              <div class="workflow-info">
                <div class="workflow-title">{{ workflow.title }}</div>
                <div class="workflow-status">{{ workflow.status }}</div>
              </div>
              <mat-icon class="workflow-chevron">chevron_right</mat-icon>
            </div>
          }
        </div>

        <div class="budget-tracker">
          <div class="budget-header">
            <span class="budget-label">üìä Budget Tracker</span>
            <span class="budget-period">
              {{ balanceData()?.lastUpdated ? (balanceData()!.lastUpdated | date:'MMM yyyy') : 'Current' }}
            </span>
          </div>
          @for (cat of budgetCategories(); track cat.label) {
            <div class="budget-item">
              <div class="budget-row-top">
                <span>{{ cat.icon }} {{ cat.label }}</span>
                <span [class.over-budget]="budgetIsOver(cat)">
                  ${{ cat.spent | number:'1.0-0' }} / ${{ cat.limit | number:'1.0-0' }}
                  @if (budgetIsOver(cat)) { <span aria-label="Over budget">‚ö†Ô∏è</span> }
                </span>
              </div>
              <div class="progress-track">
                <div class="progress-fill"
                     [class]="'progress-fill ' + cat.colorClass"
                     [style.width.%]="budgetPercent(cat)">
                </div>
              </div>
            </div>
          }
        </div>

        @if (accountHealth(); as health) {
          <div class="health-score-row">
            <span class="health-label">üè• Financial Health</span>
            <span class="health-badge" [class]="'health-badge health-' + health.level.toLowerCase()">
              {{ health.score }}/100 ¬∑ {{ health.level }}
            </span>
          </div>
        }

        <button mat-button class="upcoming-btn">
          View Upcoming <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>

    </div>
  </div>
</div>