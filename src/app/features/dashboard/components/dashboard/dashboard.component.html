<div class="dashboard-container">

  <!-- â•â•â• Ambient Background (z-index 0, purely decorative) â•â•â• -->
  <div class="bg-texture"></div>
  <div class="scan-line"></div>
  <div class="orb orb-violet"></div>
  <div class="orb orb-cyan"></div>
  <div class="orb orb-rose"></div>
  <div class="orb orb-emerald"></div>

  <!-- â•â•â• Loading Overlay â•â•â• -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner></mat-spinner>
      <p>Loading dashboard...</p>
    </div>
  }

  <!-- â•â•â• Stat Cards Row â•â•â• -->
  <div class="stat-cards-row">
    <div class="stat-card" data-color="violet">
      <div class="stat-blob"></div>
      <div class="stat-icon-wrap">ğŸ’¼</div>
      <div class="stat-label">Total Balance</div>
      <div class="stat-value">${{ totalBalance() | number:'1.0-0' }}</div>
      <span class="stat-change up">â†‘ 12.4% this month</span>
    </div>
    <div class="stat-card" data-color="cyan">
      <div class="stat-blob"></div>
      <div class="stat-icon-wrap">ğŸ“¤</div>
      <div class="stat-label">Total Spent</div>
      @if (spendingData(); as s) {
        <div class="stat-value">${{ s.total | number:'1.0-0' }}</div>
        <span class="stat-change" [class.up]="s.isPositive" [class.down]="!s.isPositive">
          {{ s.isPositive ? 'â†‘' : 'â†“' }} {{ s.changePercentage }}% vs last
        </span>
      }
    </div>
    <div class="stat-card" data-color="emerald">
      <div class="stat-blob"></div>
      <div class="stat-icon-wrap">ğŸ“¥</div>
      <div class="stat-label">Total Income</div>
      @if (incomeData(); as i) {
        <div class="stat-value">${{ i.total | number:'1.0-0' }}</div>
        <span class="stat-change" [class.up]="i.isPositive" [class.down]="!i.isPositive">
          {{ i.isPositive ? 'â†‘' : 'â†“' }} {{ i.changePercentage }}% this month
        </span>
      }
    </div>
    <div class="stat-card" data-color="rose">
      <div class="stat-blob"></div>
      <div class="stat-icon-wrap">ğŸ¯</div>
      <div class="stat-label">Savings Goal</div>
      <div class="stat-value">68%</div>
      <span class="stat-change up">â†‘ On track</span>
    </div>
  </div>

  <!-- â•â•â• Main Grid â•â•â• -->
  <div class="dashboard-grid" [class.loading]="isLoading()">

    <!-- LEFT SECTION -->
    <div class="left-section">

      <!-- Balance Card -->
      <div class="balance-card">
        <div class="balance-card-inner">
          <div class="balance-left">
            <h3 class="card-label">Total Balance in USD</h3>
            <div class="balance-amount">
              <span class="balance-live-dot"></span>
              ${{ totalBalance() | number:'1.0-0' }}
            </div>
            <div class="quick-actions">
              <button mat-raised-button color="primary" class="action-btn action-send" (click)="onSend()">
                <span class="action-icon">â†‘</span> Send
              </button>
              <button mat-stroked-button class="action-btn outlined" (click)="onRequest()">
                <span class="action-icon">â†“</span> Request
              </button>
              <button mat-stroked-button class="action-btn outlined" (click)="onTopUp()">
                <span class="action-icon">+</span> Top-Up
              </button>
            </div>
          </div>
          <div class="balance-right">
            <div class="live-indicator">
              <div class="live-dot-sm"></div>
              LIVE
              <div class="waveform">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
              </div>
            </div>
            <div class="mini-ring-wrap">
              <svg class="mini-ring" viewBox="0 0 80 80">
                <defs>
                  <linearGradient id="ringGrad" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#a78bfa"/>
                    <stop offset="100%" stop-color="#06b6d4"/>
                  </linearGradient>
                </defs>
                <circle cx="40" cy="40" r="32" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="8"/>
                <circle cx="40" cy="40" r="32" fill="none" stroke="url(#ringGrad)" stroke-width="8"
                  stroke-linecap="round" stroke-dasharray="201" stroke-dashoffset="64"
                  transform="rotate(-90 40 40)" class="ring-progress"/>
                <text x="40" y="36" text-anchor="middle" fill="white" font-size="12" font-weight="700">68%</text>
                <text x="40" y="50" text-anchor="middle" fill="rgba(255,255,255,0.6)" font-size="8">saved</text>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Transaction -->
      <div class="quick-transaction-card">
        <h3 class="card-title">
          <span class="card-title-icon">âš¡</span> Quick Transaction
        </h3>
        <div class="users-carousel">
          @for (user of quickUsers(); track user.id) {
            <div class="user-item" (click)="onUserClick(user)">
              <div class="user-avatar">
                @if (user.avatar) {
                  <img [src]="user.avatar" [alt]="user.name" />
                } @else {
                  <span>{{ user.name.charAt(0).toUpperCase() }}</span>
                }
              </div>
              <div class="user-name">{{ user.name.split(' ')[0] }}</div>
              @if (user.amount) {
                <div class="user-amount">{{ user.amount }}</div>
              }
            </div>
          }
          <button mat-icon-button class="scroll-btn">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <div class="chart-label-row">
                <span class="chart-dot-accent" style="background:#a78bfa"></span>
                <h4 class="chart-label">Total Income</h4>
              </div>
              @if (incomeData(); as income) {
                <div class="chart-value">
                  ${{ income.total | number:'1.0-0' }}
                  <span class="change-badge" [class.positive]="income.isPositive" [class.negative]="!income.isPositive">
                    <mat-icon>{{ income.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ income.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select" [value]="selectedPeriod()" (change)="onPeriodChange($any($event.target).value)">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          <div class="chart-container">
            @if (incomeChartData().length) {
              <ngx-charts-area-chart
                [results]="incomeChartData()" [xAxis]="showXAxis" [yAxis]="showYAxis"
                [gradient]="gradient" [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline" [scheme]="incomeColorScheme"
                [autoScale]="autoScale" [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <div class="chart-label-row">
                <span class="chart-dot-accent" style="background:#06b6d4"></span>
                <h4 class="chart-label">Total Spent</h4>
              </div>
              @if (spendingData(); as spending) {
                <div class="chart-value">
                  ${{ spending.total | number:'1.0-0' }}
                  <span class="change-badge" [class.positive]="spending.isPositive" [class.negative]="!spending.isPositive">
                    <mat-icon>{{ spending.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ spending.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          <div class="chart-container">
            @if (spendingChartData().length) {
              <ngx-charts-area-chart
                [results]="spendingChartData()" [xAxis]="showXAxis" [yAxis]="showYAxis"
                [gradient]="gradient" [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel" [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline" [scheme]="spendingColorScheme"
                [autoScale]="autoScale" [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="transaction-history-card">
        <div class="history-header">
          <div class="card-title-row">
            <h3 class="card-title">
              <span class="card-title-icon">ğŸ§¾</span> Transaction History
            </h3>
            <span class="history-badge">{{ filteredTransactions().length }} records</span>
          </div>
          <div class="history-controls">
            <div class="search-box">
              <mat-icon>search</mat-icon>
              <input type="text" placeholder="Search transactionsâ€¦"
                     [value]="searchQuery()"
                     (input)="onSearchChange($any($event.target).value)" />
            </div>
            <select class="period-select">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
            <button mat-icon-button class="filter-btn">
              <mat-icon>filter_list</mat-icon>
            </button>
          </div>
        </div>

        <table mat-table [dataSource]="filteredTransactions()" class="transactions-table">
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef><mat-checkbox></mat-checkbox></th>
            <td mat-cell *matCellDef="let row"><mat-checkbox></mat-checkbox></td>
          </ng-container>
          <ng-container matColumnDef="invoice">
            <th mat-header-cell *matHeaderCellDef>Invoice</th>
            <td mat-cell *matCellDef="let row">
              <div class="invoice-cell">
                <span class="invoice-icon">ğŸ“„</span>{{ row.invoice }}
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="transaction">
            <th mat-header-cell *matHeaderCellDef>Transaction</th>
            <td mat-cell *matCellDef="let row">
              <div class="transaction-cell">
                <div class="company-logo">
                  <img [src]="row.logo" [alt]="row.name" />
                </div>
                <div class="transaction-details">
                  <div class="transaction-name">{{ row.name }}</div>
                  <div class="transaction-category">{{ row.email || row.category }}</div>
                </div>
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let row">
              <div class="date-cell">
                <span class="date-main">{{ row.date | date:'dd MMM' }}</span>
                <span class="date-year">{{ row.date | date:'yyyy' }}</span>
              </div>
            </td>
          </ng-container>
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let row"
                [class.negative]="row.amount < 0"
                [class.positive]="row.amount > 0">
              <span class="amount-val">
                {{ row.amount < 0 ? 'âˆ’' : '+' }}${{ (row.amount < 0 ? row.amount * -1 : row.amount) | number:'1.2-2' }}
              </span>
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <span class="status-badge"
                    [class.completed]="row.status === 'Completed'"
                    [class.progress]="row.status === 'On Progress'"
                    [class.pending]="row.status === 'Pending'">
                @if (row.status === 'Completed') { <span>âœ“</span> }
                @else if (row.status === 'On Progress') { <span>â³</span> }
                @else { <span>ğŸ”´</span> }
                {{ row.status }}
              </span>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="right-sidebar">

      <!-- My Cards -->
      <div class="widget-card cards-widget">
        <div class="widget-header">
          <h4 class="widget-title"><span class="widget-title-icon">ğŸ’³</span> My Cards</h4>
          <button mat-button class="add-btn" (click)="onAddCard()">
            Add New <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>
        @if (currentCard(); as card) {
          <div class="credit-card">
            <div class="cc-circles"></div>
            <div class="card-top">
              <span class="card-brand">â–£ Fundwise</span>
              <span class="card-type">{{ card.brand }}</span>
            </div>
            <div class="card-holder">{{ card.cardHolder }}</div>
            <div class="card-number">{{ formatCardNumber(card.cardNumber) }}</div>
            <div class="card-footer">
              <div>
                <span class="label">Exp</span>
                <span class="value">{{ card.expiryMonth }}/{{ card.expiryYear }}</span>
              </div>
              <div>
                <span class="label">CVV</span>
                <span class="value">â€¢â€¢â€¢</span>
              </div>
            </div>
            @if (cards().length > 1) {
              <div class="card-navigation">
                <button mat-icon-button (click)="previousCard()"><mat-icon>chevron_left</mat-icon></button>
                <span>{{ selectedCard() + 1 }} / {{ cards().length }}</span>
                <button mat-icon-button (click)="nextCard()"><mat-icon>chevron_right</mat-icon></button>
              </div>
            }
          </div>
          <div class="card-limit-row">
            <span class="card-limit-label">Available limit</span>
            <span class="card-limit-val">$15,200 / $20,000</span>
          </div>
          <div class="limit-track"><div class="limit-fill"></div></div>
        }
      </div>

      <!-- Conversion Rate -->
      <div class="widget-card conversion-widget">
        <h4 class="widget-title"><span class="widget-title-icon">ğŸ”„</span> Conversion Rate</h4>
        <div class="conversion-form">
          <div class="conversion-row">
            <label>From</label>
            <div class="input-group">
              <input type="number" [value]="conversionAmount1()"
                     (input)="conversionAmount1.set(+$any($event.target).value)" />
              <select [value]="conversionCurrency1()"
                      (change)="conversionCurrency1.set($any($event.target).value)">
                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                <option value="GBP">ğŸ‡¬ğŸ‡§ GBP</option>
              </select>
            </div>
          </div>
          <div class="conversion-swap-row">
            <div class="conversion-line"></div>
            <div class="swap-icon">â‡…</div>
            <div class="conversion-line"></div>
          </div>
          <div class="conversion-row">
            <label>To</label>
            <div class="input-group">
              <input type="number" [value]="conversionAmount2()"
                     (input)="conversionAmount2.set(+$any($event.target).value)" />
              <select [value]="conversionCurrency2()"
                      (change)="conversionCurrency2.set($any($event.target).value)">
                <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
                <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
                <option value="GBP">ğŸ‡¬ğŸ‡§ GBP</option>
              </select>
            </div>
          </div>
          <button mat-raised-button color="primary" class="convert-btn" (click)="convert()">
            <mat-icon>swap_horiz</mat-icon>
            Convert {{ conversionAmount1() }} {{ conversionCurrency1() }}
            = {{ conversionAmount2() | number:'1.2-2' }} {{ conversionCurrency2() }}
          </button>
        </div>
        <div class="live-rates">
          <div class="live-rates-header">
            <span class="rates-label">Live Rates</span>
            <div class="live-indicator-sm">
              <div class="live-dot-sm"></div> LIVE
            </div>
          </div>
          <div class="rate-row">
            <span class="rate-flag">ğŸ‡ªğŸ‡º</span>
            <span class="rate-pair">EUR/USD</span>
            <span class="rate-sparkline">â–â–ƒâ–…â–‡â–…â–†â–‡</span>
            <span class="rate-val up">1.0842 <small>+0.12%</small></span>
          </div>
          <div class="rate-row">
            <span class="rate-flag">ğŸ‡¬ğŸ‡§</span>
            <span class="rate-pair">GBP/USD</span>
            <span class="rate-sparkline">â–‡â–…â–ƒâ–…â–ƒâ–‚â–ƒ</span>
            <span class="rate-val down">1.2611 <small>-0.08%</small></span>
          </div>
          <div class="rate-row">
            <span class="rate-flag">ğŸ‡¯ğŸ‡µ</span>
            <span class="rate-pair">JPY/USD</span>
            <span class="rate-sparkline">â–‚â–„â–…â–ƒâ–†â–‡â–†</span>
            <span class="rate-val up">149.82 <small>+0.31%</small></span>
          </div>
        </div>
      </div>

      <!-- Workflows + Budget -->
      <div class="widget-card workflows-widget">
        <div class="widget-header">
          <h4 class="widget-title"><span class="widget-title-icon">âš™ï¸</span> Workflows</h4>
          <button mat-icon-button class="add-icon-btn">
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>
        <div class="workflow-list">
          @for (workflow of workflows(); track workflow.id) {
            <div class="workflow-item" (click)="onWorkflowClick(workflow)">
              <div class="workflow-icon">{{ workflow.icon }}</div>
              <div class="workflow-info">
                <div class="workflow-title">{{ workflow.title }}</div>
                <div class="workflow-status">{{ workflow.status }}</div>
              </div>
              <mat-icon class="workflow-chevron">chevron_right</mat-icon>
            </div>
          }
        </div>
        <div class="budget-tracker">
          <div class="budget-header">
            <span class="budget-label">ğŸ“Š Budget Tracker</span>
            <span class="budget-period">Feb 2026</span>
          </div>
          <div class="budget-item">
            <div class="budget-row-top"><span>ğŸ  Housing</span><span>$1,840 / $2,000</span></div>
            <div class="progress-track"><div class="progress-fill violet" style="width:92%"></div></div>
          </div>
          <div class="budget-item">
            <div class="budget-row-top"><span>ğŸ” Food</span><span>$380 / $600</span></div>
            <div class="progress-track"><div class="progress-fill cyan" style="width:63%"></div></div>
          </div>
          <div class="budget-item">
            <div class="budget-row-top"><span>ğŸš— Transport</span><span>$190 / $400</span></div>
            <div class="progress-track"><div class="progress-fill emerald" style="width:47%"></div></div>
          </div>
          <div class="budget-item">
            <div class="budget-row-top">
              <span>ğŸ›ï¸ Shopping</span>
              <span class="over-budget">$540 / $500 âš ï¸</span>
            </div>
            <div class="progress-track"><div class="progress-fill rose" style="width:100%"></div></div>
          </div>
        </div>
        <button mat-button class="upcoming-btn">
          View Upcoming <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>

    </div>
  </div>
</div>