<div class="dashboard-container">
  <!-- Loading Spinner -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner></mat-spinner>
      <p>Loading dashboard...</p>
    </div>
  }

  <div class="dashboard-grid" [class.loading]="isLoading()">
    <!-- Left Section -->
    <div class="left-section">
      <!-- Balance Card -->
      <div class="balance-card">
        <h3 class="card-label">Total Balance in USD</h3>
        <div class="balance-amount">${{ totalBalance() | number:'1.0-0' }}</div>
        
        <div class="quick-actions">
          <button mat-raised-button color="primary" class="action-btn" (click)="onSend()">
            <mat-icon>arrow_upward</mat-icon>
            Send
          </button>
          <button mat-stroked-button class="action-btn outlined" (click)="onRequest()">
            <mat-icon>arrow_downward</mat-icon>
            Request
          </button>
          <button mat-stroked-button class="action-btn outlined" (click)="onTopUp()">
            <mat-icon>add</mat-icon>
            Top-Up
          </button>
        </div>
      </div>

      <!-- Quick Transaction -->
      <div class="quick-transaction-card">
        <h3 class="card-title">Quick Transaction</h3>
        
        <div class="users-carousel">
          @for (user of quickUsers(); track user.id) {
            <div class="user-item" (click)="onUserClick(user)">
              <div class="user-avatar">
                @if (user.avatar) {
                  <img [src]="user.avatar" [alt]="user.name" />
                } @else {
                  <span>{{ user.name.charAt(0).toUpperCase() }}</span>
                }
              </div>
              <div class="user-name">{{ user.name.split(' ')[0] }}</div>
              @if (user.amount) {
                <div class="user-amount">{{ user.amount }}</div>
              }
            </div>
          }
          
          <button mat-icon-button class="scroll-btn">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <!-- Income Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <h4 class="chart-label">Total Income</h4>
              @if (incomeData(); as income) {
                <div class="chart-value">
                  ${{ income.total | number:'1.0-0' }}
                  <span class="change-badge" [class.positive]="income.isPositive" [class.negative]="!income.isPositive">
                    <mat-icon>{{ income.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ income.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select" [value]="selectedPeriod()" (change)="onPeriodChange($any($event.target).value)">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          
          <div class="chart-container">
            @if (incomeChartData().length) {
              <ngx-charts-area-chart
                [results]="incomeChartData()"
                [xAxis]="showXAxis"
                [yAxis]="showYAxis"
                [gradient]="gradient"
                [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline"
                [scheme]="incomeColorScheme"
                [autoScale]="autoScale"
                [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>

        <!-- Spent Chart -->
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-info">
              <h4 class="chart-label">Total Spent</h4>
              @if (spendingData(); as spending) {
                <div class="chart-value">
                  ${{ spending.total | number:'1.0-0' }}
                  <span class="change-badge" [class.positive]="spending.isPositive" [class.negative]="!spending.isPositive">
                    <mat-icon>{{ spending.isPositive ? 'trending_up' : 'trending_down' }}</mat-icon>
                    {{ spending.changePercentage }}%
                  </span>
                </div>
              }
            </div>
            <select class="period-select">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
          </div>
          
          <div class="chart-container">
            @if (spendingChartData().length) {
              <ngx-charts-area-chart
                [results]="spendingChartData()"
                [xAxis]="showXAxis"
                [yAxis]="showYAxis"
                [gradient]="gradient"
                [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel"
                [timeline]="timeline"
                [scheme]="spendingColorScheme"
                [autoScale]="autoScale"
                [curve]="curve">
              </ngx-charts-area-chart>
            }
          </div>
        </div>
      </div>

      <!-- Transaction History -->
      <div class="transaction-history-card">
        <div class="history-header">
          <h3 class="card-title">Transaction history</h3>
          
          <div class="history-controls">
            <div class="search-box">
              <mat-icon>search</mat-icon>
              <input 
                type="text" 
                placeholder="Search Transaction" 
                [value]="searchQuery()"
                (input)="onSearchChange($any($event.target).value)"
              />
            </div>
            
            <select class="period-select">
              <option>Last 30 days</option>
              <option>Last 60 days</option>
              <option>Last 90 days</option>
            </select>
            
            <button mat-icon-button>
              <mat-icon>filter_list</mat-icon>
            </button>
          </div>
        </div>

        <table mat-table [dataSource]="filteredTransactions()" class="transactions-table">
          <!-- Checkbox Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox></mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row">
              <mat-checkbox></mat-checkbox>
            </td>
          </ng-container>

          <!-- Invoice Column -->
          <ng-container matColumnDef="invoice">
            <th mat-header-cell *matHeaderCellDef>Invoice</th>
            <td mat-cell *matCellDef="let row">
              <div class="invoice-cell">
                <mat-icon>description</mat-icon>
                {{ row.invoice }}
              </div>
            </td>
          </ng-container>

          <!-- Transaction Column -->
          <ng-container matColumnDef="transaction">
            <th mat-header-cell *matHeaderCellDef>Transactions</th>
            <td mat-cell *matCellDef="let row">
              <div class="transaction-cell">
                <div class="company-logo">
                  <img [src]="row.logo" [alt]="row.name" />
                </div>
                <div class="transaction-details">
                  <div class="transaction-name">{{ row.name }}</div>
                  <div class="transaction-category">{{ row.email || row.category }}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let row">{{ row.date | date:'dd MMM, yyyy' }}</td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Amount</th>
            <td mat-cell *matCellDef="let row" 
                [class.negative]="row.amount < 0"
                [class.positive]="row.amount > 0">
              {{ row.amount < 0 ? '-' : '+' }}${{ (row.amount < 0 ? row.amount * -1 : row.amount) | number:'1.2-2' }}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <span class="status-badge" 
                    [class.completed]="row.status === 'Completed'" 
                    [class.progress]="row.status === 'On Progress'"
                    [class.pending]="row.status === 'Pending'">
                @if (row.status === 'Completed') {
                  <mat-icon>check_circle</mat-icon>
                } @else if (row.status === 'On Progress') {
                  <mat-icon>schedule</mat-icon>
                } @else {
                  <mat-icon>pending</mat-icon>
                }
                {{ row.status }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <!-- My Cards -->
      <div class="widget-card cards-widget">
        <div class="widget-header">
          <h4 class="widget-title">My Cards</h4>
          <button mat-button class="add-btn" (click)="onAddCard()">
            Add New
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>
        
        @if (currentCard(); as card) {
          <div class="credit-card">
            <div class="card-top">
              <span class="card-brand">Fundwise</span>
              <span class="card-type">{{ card.brand }}</span>
            </div>
            
            <div class="card-holder">{{ card.cardHolder }}</div>
            <div class="card-number">{{ formatCardNumber(card.cardNumber) }}</div>
            
            <div class="card-footer">
              <div class="card-expiry">
                <span class="label">Exp</span>
                <span class="value">{{ card.expiryMonth }}/{{ card.expiryYear }}</span>
              </div>
              <div class="card-cvv">
                <span class="label">CVV</span>
                <span class="value">{{ card.cvv }}</span>
              </div>
            </div>

            @if (cards().length > 1) {
              <div class="card-navigation">
                <button mat-icon-button (click)="previousCard()">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <span>{{ selectedCard() + 1 }} / {{ cards().length }}</span>
                <button mat-icon-button (click)="nextCard()">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </div>

      <!-- Conversion Rate -->
      <div class="widget-card conversion-widget">
        <h4 class="widget-title">Conversion Rate</h4>
        
        <div class="conversion-form">
          <div class="conversion-row">
            <label>Amount</label>
            <div class="input-group">
              <input 
                type="number" 
                [value]="conversionAmount1()"
                (input)="conversionAmount1.set(+$any($event.target).value)"
              />
              <select 
                [value]="conversionCurrency1()"
                (change)="conversionCurrency1.set($any($event.target).value)"
              >
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>
          
          <div class="conversion-row">
            <div class="input-group">
              <input 
                type="number" 
                [value]="conversionAmount2()"
                (input)="conversionAmount2.set(+$any($event.target).value)"
              />
              <select 
                [value]="conversionCurrency2()"
                (change)="conversionCurrency2.set($any($event.target).value)"
              >
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>
          
          <button mat-raised-button color="primary" class="convert-btn" (click)="convert()">
            Convert 
            <mat-icon>arrow_forward</mat-icon>
            {{ conversionAmount1() }} {{ conversionCurrency1() }} = {{ conversionAmount2() | number:'1.2-2' }} {{ conversionCurrency2() }}
          </button>
        </div>
      </div>

      <!-- Workflows -->
      <div class="widget-card workflows-widget">
        <div class="widget-header">
          <h4 class="widget-title">Workflows</h4>
          <button mat-icon-button>
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>
        
        <div class="workflow-list">
          @for (workflow of workflows(); track workflow.id) {
            <div class="workflow-item" (click)="onWorkflowClick(workflow)">
              <div class="workflow-icon">{{ workflow.icon }}</div>
              <div class="workflow-info">
                <div class="workflow-title">{{ workflow.title }}</div>
                <div class="workflow-status">{{ workflow.status }}</div>
              </div>
              <mat-icon>chevron_right</mat-icon>
            </div>
          }
        </div>
        
        <button mat-button class="upcoming-btn">
          Upcoming
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>